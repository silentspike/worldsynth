name: CI

on:
  push:
    branches: [main, sprint-1, sprint-2, sprint-3, sprint-4]
  pull_request:
    branches: [main, sprint-1, sprint-2, sprint-3, sprint-4]

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ── Gate: Changes Detection ──────────────────────────────────────
  changes:
    runs-on: ubuntu-latest
    outputs:
      zig: ${{ steps.filter.outputs.zig }}
      ui: ${{ steps.filter.outputs.ui }}
      ci: ${{ steps.filter.outputs.ci }}
      docs-only: ${{ steps.filter.outputs.docs-only }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            zig:
              - 'src/**'
              - 'build.zig'
              - 'build.zig.zon'
              - 'clap-sdk/**'
            ui:
              - 'ui/**'
            ci:
              - '.github/**'
            docs-only:
              - '**/*.md'
              - 'docs/**'
              - 'LICENSE'
              - '.editorconfig'

  # ── PR Gate: Lint (always runs) ──────────────────────────────────
  lint:
    runs-on: ubuntu-latest
    needs: [changes]
    steps:
      - uses: actions/checkout@v6

      - name: Check for hidden Unicode/Bidi characters (CVE-2021-42574)
        run: |
          if grep -rP '[\x{200B}-\x{200F}\x{202A}-\x{202E}\x{2066}-\x{2069}]' \
            --include='*.zig' --include='*.ts' --include='*.js' --include='*.svelte' \
            --include='*.yml' --include='*.yaml' --include='*.json' .; then
            echo "::error::Hidden Unicode/Bidi characters found!"
            exit 1
          fi

      - name: Check Zig formatting
        if: (needs.changes.outputs.zig == 'true' || github.event_name == 'push') && hashFiles('build.zig') != ''
        uses: mlugg/setup-zig@v2
        with:
          version: 0.14.1

      - name: Run zig fmt --check
        if: (needs.changes.outputs.zig == 'true' || github.event_name == 'push') && hashFiles('build.zig') != ''
        run: |
          if [ -d src/ ]; then
            find src/ -name '*.zig' -print0 | xargs -r -0 zig fmt --check 2>&1 || {
              echo "::error::Zig formatting check failed. Run 'zig fmt' locally."
              exit 1
            }
          else
            echo "::notice::src/ directory not found, skipping zig fmt check"
          fi

  # ── PR Gate: Zig Build + Test ────────────────────────────────────
  build-zig:
    runs-on: ubuntu-latest
    if: >-
      hashFiles('build.zig') != '' &&
      (needs.changes.outputs.zig == 'true' ||
      needs.changes.outputs.ci == 'true' ||
      github.event_name == 'push')
    needs: [changes]
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - uses: mlugg/setup-zig@v2
        with:
          version: 0.14.1

      # Zig cache: .zig-cache/ and zig-cache/ directories
      - uses: actions/cache@v4
        with:
          path: |
            .zig-cache/
            zig-cache/
            ~/.cache/zig/
          key: zig-${{ runner.os }}-${{ hashFiles('build.zig', 'build.zig.zon', 'src/**/*.zig') }}
          restore-keys: |
            zig-${{ runner.os }}-

      # Install ALSA/JACK dev headers for audio I/O compilation
      - name: Install audio dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            libasound2-dev \
            libjack-jackd2-dev \
            libwebkit2gtk-4.1-dev \
            pkg-config

      - name: Build
        run: zig build

      - name: Test
        run: zig build test

      # Build CLAP plugin artifact (verify it produces .clap)
      - name: Verify CLAP plugin artifact
        run: |
          if [ -f zig-out/lib/worldsynth.clap ]; then
            echo "CLAP plugin built: $(ls -lh zig-out/lib/worldsynth.clap)"
          else
            echo "::notice::No .clap artifact yet (expected until plugin build is implemented)"
          fi

  # ── PR Gate: UI Build + TypeCheck ────────────────────────────────
  build-ui:
    runs-on: ubuntu-latest
    if: >-
      hashFiles('ui/package.json') != '' &&
      (needs.changes.outputs.ui == 'true' ||
      needs.changes.outputs.ci == 'true' ||
      github.event_name == 'push')
    needs: [changes]
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: ui/package-lock.json

      - name: Install dependencies
        run: cd ui && npm ci

      - name: Build
        run: cd ui && npm run build

      - name: Type check
        run: cd ui && npm run check

      # npm audit blocks on high+ severity vulnerabilities
      - name: Security audit
        run: cd ui && npm audit --audit-level=high

  # ── PR Gate: Security ────────────────────────────────────────────
  security:
    runs-on: ubuntu-latest
    if: >-
      needs.changes.outputs.zig == 'true' ||
      needs.changes.outputs.ui == 'true' ||
      needs.changes.outputs.ci == 'true' ||
      github.event_name == 'push'
    needs: [changes]
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install gitleaks
        run: |
          GITLEAKS_VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | grep '"tag_name"' | sed 's/.*"v\(.*\)".*/\1/')
          curl -sSfL "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" | tar xz -C /usr/local/bin gitleaks

      - name: Scan for secrets (gitleaks)
        run: gitleaks detect --source . --verbose --redact
